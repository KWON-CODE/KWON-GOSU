<!DOCTYPE html><html lang="ko" xmlns:th="http://www.thymeleaf.org"
                     th:replace="~{fragments/layout :: layout(pageTitle='새 글 작성',
  content=~{::main})}">


<main class="container mt-5">
  <div class="container pt-4">
    <h2>새 글 작성</h2>
    <div class="form-wrapper">

      <form th:action="@{/posts/new}"  method="post"
            enctype="multipart/form-data"
            onsubmit="document.getElementById('submit-btn').disabled=true;
          document.getElementById('submit-btn').innerText='처리 중...';">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

        <input type="hidden" name="category" th:value="${param.category}" />

        <div class="mb-3">
          <label for="title" class="form-label">제목</label>
          <input type="text" class="form-control" id="title" name="title" required>
        </div>

        <div class="mb-3" th:if="${category.name() == 'RECRUIT' or category.name() == 'SELL'}">
          <label for="price" class="form-label">가격</label>
          <div class="input-group">
            <input type="number" class="form-control" id="price" name="price" placeholder="숫자만 입력" required>
            <span class="input-group-text">원</span>
          </div>
        </div>

        <div class="mb-3">
          <label for="content" class="form-label">내용</label>
          <textarea class="form-control" id="content" name="content" rows="10" required></textarea>
        </div>



        <div class="mb-3">
          <label for="imageFiles" class="form-label">이미지 첨부</label>
          <input type="file" id="imageFiles" name="imageFiles" multiple style="visibility: hidden; position: absolute; left: -9999px;">

          <div class="form-control" id="file-display-area" style="cursor: pointer;  min-height: 50px; height: auto;">
            <span id="file-placeholder" class="text-muted">클릭하여 파일을 추가하세요.</span>
          </div>
          <div class="mt-2">
            <button type="button" id="clear-files-btn" class="btn btn-sm btn-outline-danger" style="display: none;">전체 파일 삭제</button>
          </div>
        </div>

        <div class="d-flex justify-content-end gap-2 mt-4">
          <div id="image-preview-container" class="mt-2">
            <!-- 예: <div class="preview-item">cat.jpg <button>삭제</button></div> -->
          </div>

          <button type="submit" class="btn btn-primary" id="submit-btn">등록</button>
          <a href="/posts" class="btn btn-secondary">취소</a>
        </div>
      </form>
    </div>
  </div>

  <!-- 다른 HTML 코드는 그대로 두시고, <script> 태그 부분만 아래 내용으로 교체하세요. -->
  <script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
      let totalFiles = [];
      const MAX_FILES = 10;
      const fileDisplayArea = document.getElementById('file-display-area');
      const form = document.querySelector('form');
      const submitBtn = document.getElementById('submit-btn');
      const hiddenFileInput = document.getElementById('imageFiles');

      function isImageFile(file) {
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp', 'image/bmp'];
        return allowedTypes.includes(file.type.toLowerCase());
      }

      // FileList를 동적으로 생성하는 함수
      function createFileList(files) {
        const dataTransfer = new DataTransfer();
        files.forEach(file => dataTransfer.items.add(file));
        return dataTransfer.files;
      }

      function updateFileDisplay() {
        fileDisplayArea.innerHTML = '';
        const placeholder = document.createElement('span');
        placeholder.id = 'file-placeholder';
        placeholder.className = 'text-muted';
        placeholder.textContent = '클릭하여 파일을 추가하세요.';
        fileDisplayArea.appendChild(placeholder);

        if (totalFiles.length === 0) {
          placeholder.style.display = 'inline';
          // 빈 FileList 설정
          hiddenFileInput.files = createFileList([]);
        } else {
          placeholder.style.display = 'none';
          totalFiles.forEach((file, index) => {
            const tag = document.createElement('span');
            tag.className = 'file-tag';
            const name = document.createTextNode(file.name);
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'delete-tag-btn';
            btn.textContent = '×';
            btn.setAttribute('data-index', index);
            btn.addEventListener('click', e => {
              e.stopPropagation();
              totalFiles.splice(index, 1);
              updateFileDisplay();
            });
            tag.append(name, btn);
            fileDisplayArea.appendChild(tag);
          });

          // 실제 FileList 업데이트
          hiddenFileInput.files = createFileList(totalFiles);
        }
      }

      fileDisplayArea.addEventListener('click', e => {
        if (e.target.classList.contains('delete-tag-btn')) {
          return;
        }

        const input = document.createElement('input');
        input.type = 'file';
        input.multiple = true;
        input.accept = 'image/*';

        input.onchange = function () {
          const files = Array.from(input.files);

          if (totalFiles.length + files.length > MAX_FILES) {
            alert(`파일은 최대 ${MAX_FILES}개까지 첨부 가능합니다.`);
            return;
          }

          files.forEach(f => {
            if (f.size > 0 && isImageFile(f)) {
              totalFiles.push(f);
            }
          });
          updateFileDisplay();
        };

        input.click();
      });

      // 기본 폼 제출 처리
      form.addEventListener('submit', function (event) {
        submitBtn.disabled = true;
        submitBtn.innerText = '처리 중...';
      });
    });
  </script>

</main>
<style>
  /* 파일 태그 스타일 */
  .file-tag {
    display: inline-flex;
    align-items: center;
    background-color: #e9ecef;
    border: 1px solid #ced4da;
    border-radius: 0.25rem;
    padding: 0.25rem 0.5rem;
    margin-right: 0.5rem;
    margin-bottom: 0.5rem;
    font-size: 0.9em;
  }
  /* 태그 안의 삭제 버튼(x) 스타일 */
  .delete-tag-btn {
    display: inline-block;
    width: 1.2em;
    height: 1.2em;
    margin-left: 0.5rem;
    background-color: #6c757d;
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    font-weight: bold;
    line-height: 1.2em; /* 텍스트 수직 중앙 정렬 */
    text-align: center;
    padding: 0;
  }
  .delete-tag-btn:hover {
    background-color: #dc3545;
  }
</style>
</html>