<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: layout(pageTitle='서비스 제공자 가입',
      content=~{::main})}">

<main class="container mt-5">

    <div class="form-card form-card-wide" style="max-width: 600px; margin: auto;">
        <div class="form-header">
            <h2>서비스 제공자 가입</h2>
        </div>
        <div class="form-body">
            <div th:if="${error}" class="alert alert-danger" role="alert" th:text="${error}">
                실패 메시지가 여기에 표시됩니다.
            </div>
            <form th:action="@{/providers/new}"
                  th:object="${providerDto}"
                  method="post" enctype="multipart/form-data">
                <input type="hidden" th:name="${_csrf.parameterName}"
                       th:value="${_csrf.token}" />
                <div th:if="${#fields.hasAnyErrors()}"
                     class="alert alert-warning">
                    <ul>
                        <li th:each="err : ${#fields.allErrors()}" th:text="${err}"></li>
                    </ul>
                </div>

                <h5 class="form-section-title">기본 정보</h5>
                <div class="mb-3">
                    <label class="form-label">닉네임</label>
                    <input type="text" class="form-control" id="username" th:field="*{username}" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">이메일</label>
                    <input type="email" class="form-control" id="email" th:field="*{email}" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">비밀번호 (8자 이상)</label>
                    <input type="password" class="form-control" id="password"
                           th:field="*{password}" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">비밀번호 확인</label>
                    <input type="password" class="form-control" id="passwordConfirm"
                           th:field="*{passwordConfirm}" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">개인 연락처</label>
                    <input type="text" class="form-control" th:field="*{phoneNumber}" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">주소</label>
                    <div class="input-group mb-2">
                        <input type="text" id="zipcode" th:field="*{zipcode}" class="form-control" placeholder="우편번호" readonly>
                        <button type="button" class="btn btn-secondary" onclick="execDaumPostcode()">주소 검색</button>
                    </div>
                    <input type="text" id="mainAddress" th:field="*{mainAddress}" class="form-control mb-2" placeholder="주소" readonly>
                    <input type="text" id="detailAddress" th:field="*{detailAddress}" class="form-control" placeholder="상세주소 입력">
                </div>

                <hr>
                <h5 class="form-section-title">제공자 정보</h5>
                <div class="mb-3">
                    <label class="form-label">프로필 사진 (선택)</label>
                    <input class="form-control" type="file" th:field="*{profileImage}">
                </div>
                <div class="mb-3">
                    <label class="form-label">업체/개인명</label>
                    <input type="text" class="form-control" th:field="*{providerName}" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">업체 연락처</label>
                    <input type="text" class="form-control" th:field="*{contactPhone}" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">사업자등록번호 (선택, 숫자 10자리)</label>
                    <input type="text" class="form-control"
                   th:field="*{businessRegistrationNumber}"
                           id="businessRegistrationNumber">
                    <div id="brn-validation-message" class="mt-1"></div>
                </div>
                <div class="mb-3">
                    <label class="form-label">담당자명 (선택)</label>
                    <input type="text" class="form-control" th:field="*{contactPerson}">
                </div>
                <div class="mb-3">
                    <label class="form-label">업체 소개 (선택)</label>
                    <textarea class="form-control" rows="3" th:field="*{description}"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">주요 서비스 유형</label>
                    <select class="form-select" th:field="*{providerType}" required>
                        <option value="">-- 유형 선택 --</option>
                        <option th:each="t : ${T(com.cleaning.platform.domain.ProviderType).values()}" th:value="${t}" th:text="${t.name()}"></option>
                    </select>
                </div>
                <div class="d-grid"><button type="submit" class="btn btn-primary">
                    가입 신청</button></div>
            </form>
        </div>
    </div>

    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=7d0f7e6b43b1f448b83a91468adb582d"></script>

    <script>
        function execDaumPostcode() {
            new daum.Postcode({
                oncomplete: function(data) {
                    let addr = (data.userSelectedType === 'R') ? data.roadAddress : data.jibunAddress;
                    document.getElementById('zipcode').value = data.zonecode;
                    document.getElementById("mainAddress").value = addr;
                    document.getElementById("detailAddress").focus();
                }
            }).open();
        }
    </script>

    <script>
        const brnInput = document.getElementById('businessRegistrationNumber');
        if (brnInput) {
            const brnMessageDiv = document.getElementById('brn-validation-message');
            let brnDebounceTimer;

            brnInput.addEventListener('keyup', () => {
                clearTimeout(brnDebounceTimer);
                brnDebounceTimer = setTimeout(() => {
                    const brn = brnInput.value.replace(/-/g, ''); // 하이픈 제거

                    if (brn.length === 10 && /^\d+$/.test(brn)) {
                        fetch(`/api/providers/check-brn?brn=${brn}`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.isValid) {
                                    brnMessageDiv.innerHTML = '<span class="text-success">확인된 사업자등록번호입니다.</span>';
                                } else {
                                    brnMessageDiv.innerHTML = '<span class="text-danger">유효하지 않거나 휴/폐업 상태의 사업자등록번호입니다.</span>';
                                }
                            });
                    } else {
                        brnMessageDiv.innerHTML = '';
                    }
                }, 500);
            });
        }
    </script>

    <script>
        const passwordInput = document.getElementById('password');
        const passwordConfirmInput = document.getElementById('passwordConfirm');


        const messageDiv = document.createElement('div');
        passwordConfirmInput.parentNode.appendChild(messageDiv);


        function validatePassword() {
            const password = passwordInput.value;
            const passwordConfirm = passwordConfirmInput.value;

            if (passwordConfirm === '') {

                messageDiv.innerHTML = '';
                passwordConfirmInput.classList.remove('is-valid', 'is-invalid');
            } else if (password === passwordConfirm) {
                messageDiv.innerHTML = '<span class="text-success">비밀번호가 일치합니다.</span>';
                passwordConfirmInput.classList.remove('is-invalid');
                passwordConfirmInput.classList.add('is-valid'); // 초록색 테두리 (부트스트랩 클래스)
            } else {

                messageDiv.innerHTML = '<span class="text-danger">비밀번호가 일치하지 않습니다.</span>';
                passwordConfirmInput.classList.remove('is-valid');
                passwordConfirmInput.classList.add('is-invalid'); // 빨간색 테두리 (부트스트랩 클래스)
            }
        }

        passwordInput.addEventListener('keyup', validatePassword);
        passwordConfirmInput.addEventListener('keyup', validatePassword);

        const emailInput = document.getElementById('email');
        const emailMessageDiv = document.createElement('div');
        emailInput.parentNode.insertBefore(emailMessageDiv, emailInput.nextSibling);

        let debounceTimer;

        emailInput.addEventListener('keyup', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const email = emailInput.value;
                if (email.length > 0 && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    fetch(`/api/users/check-email?email=${email}` ,
                        {
                            headers: { 'Accept': 'application/json' }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.duplicated) {
                                emailMessageDiv.innerHTML = '<span class="text-danger">이미 사용 중인 이메일입니다.</span>';
                            } else {
                                emailMessageDiv.innerHTML = '<span class="text-success">사용 가능한 이메일입니다.</span>';
                            }
                        });
                } else {
                    emailMessageDiv.innerHTML = '';
                }
            }, 500);
        });
    </script>
    <script>
        const usernameInput = document.getElementById('username');
        if (usernameInput) {
            const usernameMessageDiv = document.createElement('div');
            usernameInput.parentNode.insertBefore(usernameMessageDiv, usernameInput.nextSibling);
            let usernameDebounceTimer;

            usernameInput.addEventListener('keyup', () => {
                clearTimeout(usernameDebounceTimer);
                usernameDebounceTimer = setTimeout(() => {
                    const username = usernameInput.value;
                    if (username.length > 1) {
                        fetch(`/api/users/check-username?username=${encodeURIComponent(username)}`,
                            {
                                   headers: { 'Accept': 'application/json' }
                             })
                            .then(response => response.json())
                            .then(data => {
                                if (data.duplicated) {
                                    usernameMessageDiv.innerHTML = '<span class="text-danger">이미 사용 중인 닉네임입니다.</span>';
                                } else {
                                    usernameMessageDiv.innerHTML = '<span class="text-success">사용 가능한 닉네임입니다.</span>';
                                }
                            });
                    } else {
                        usernameMessageDiv.innerHTML = '';
                    }
                }, 500);
            });
        }
    </script>
</main>

</html>