<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: layout(pageTitle='서비스 제공자 목록',
      content=~{::main})}">


<main class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2><i class="bi bi-person-workspace"></i> 서비스 제공자 목록</h2>
        <a href="/providers/new" class="btn btn-primary">
            <i class="bi bi-shop"></i> 서비스 제공자로 입점하기
        </a>
    </div>

    <div class="card mb-4 wowPop" style="animation-delay: 0.1s;">
        <div class="card-body">
            <div class="row g-3 align-items-center">
                <div class="col-md-6">
                    <div class="input-group">
                        <input type="text" id="keyword-input" class="form-control" placeholder="업체명으로 검색...">
                        <button class="btn btn-outline-secondary" type="button" onclick="searchProviders()">
                            <i class="bi bi-search"></i> 검색
                        </button>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="input-group">
                        <label class="input-group-text" for="sort-select"><i class="bi bi-sort-down"></i> 정렬</label>
                        <select class="form-select" id="sort-select" onchange="searchProviders()">
                            <option value="trustScore,desc">추천순 (신뢰도)</option>
                            <option value="providerName,asc">이름순</option>
                            <option value="naverVisitorReviewCount,desc">리뷰 많은 순</option>
                            <option value="averageRating,desc">평점 높은 순</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div th:if="${#lists.isEmpty(providers)}" class="alert alert-info text-center">
        등록된 서비스 제공자가 없습니다.
    </div>

    <div class="card wowPop" style="animation-delay: 0.2s;">
        <div class="card-body p-0">
    <table class="table table-hover align-middle mb-0">
        <thead class="table-dark">
        <tr>
            <th style="width: 10%;">프로필</th>
            <th style="width: 20%;">업체/개인명</th>
            <th style="width: 20%;">신뢰도 점수</th>
            <th style="width: 20%;">업체 연락처</th>
            <th style="width: 15%;">주요 서비스 타입</th>
            <th style="width: 15%;">평점/리뷰</th>
        </tr>
        </thead>
        <tbody id="provider-table-body">

        </tbody>
    </table>
        </div>
    </div>

    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center" id="pagination">
        </ul>
    </nav>

    <script>
        let currentPage = 0, currentSort = 'trustScore,desc', currentKeyword = '';

        function searchProviders() {
            currentPage = 0;
            currentSort = document.getElementById('sort-select').value;
            currentKeyword = document.getElementById('keyword-input').value;
            fetchAndRenderProviders();
        }

        function fetchAndRenderProviders(page = currentPage) {
            currentPage = page;

            const params = new URLSearchParams({
                page: currentPage,
                size: '20',
                sort: currentSort,
                keyword: currentKeyword || ''
            });
            const url = `/api/providers?${params.toString()}`;

            fetch(url, {
                headers: {
                    'Accept': 'application/json'
                }
            })
                .then(async response => {
                    const contentType = response.headers.get('content-type');
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP error! status: ${response.status}\nResponse: ${errorText.slice(0, 300)}`);
                    }
                    if (!contentType || !contentType.includes('application/json')) {
                        const errorText = await response.text();
                        throw new TypeError(`Expected JSON but received ${contentType}.\nResponse: ${errorText.slice(0, 300)}`);
                    }
                    return response.json();
                })
                .then(pageData => {
                    renderTable(pageData.content);
                    renderPagination(pageData);
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('provider-table-body').innerHTML = '<tr><td colspan="6" class="text-center text-danger">데이터를 불러오는 중 오류가 발생했습니다.</td></tr>';
                });
        }

        function renderTable(providers) {
            const tableBody = document.getElementById('provider-table-body');
            tableBody.innerHTML = '';
            if (providers.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center">검색 결과가 없습니다.</td></tr>';
                return;
            }
            providers.forEach((p, index) => {
                const profileImage = p.profileImageName ? `<img src="/images/${p.profileImageName}" alt="프로필" width="60" height="60" class="rounded-circle img-thumbnail">` : `<i class="bi bi-person-circle fs-2 text-secondary"></i>`;
                const providerLink = p.externalPlaceUrl ? `<a href="${p.externalPlaceUrl}" target="_blank" class="ms-2" title="업체 홈페이지"><i class="bi bi-box-arrow-up-right"></i></a>` : '';
                const naverMapLink = `<a href="https://map.naver.com/p/search/${p.providerName}" target="_blank" class="ms-1" title="네이버 지도 검색"><i class="bi bi-geo-alt-fill text-success"></i></a>`;


                const ratingHtml = `<div class="d-flex align-items-center">
                <i class="bi bi-star-fill text-warning me-1"></i>
                <strong>${p.averageRating != null ? p.averageRating.toFixed(1) : '0.0'}</strong>
                </div>`;

                const reviewHtml = p.naverVisitorReviewCount > 0 ? `<div class="d-flex align-items-center mt-1 text-white-50">
               <i class="bi bi-people-fill text-success me-1"></i>
                <small>${p.naverVisitorReviewCount.toLocaleString()}</small>
                </div>` : '';

                const row = `<tr class="wowPop" style="animation-delay: ${0.1 + index * 0.05}s;">
                            <td>${profileImage}</td>
                            <td>
                          <h6 class="mb-0"><strong>${p.providerName}</strong> </h6>
                            <div> ${providerLink} ${naverMapLink} </div>
                            </td>
                            <td><span class="badge bg-primary">${p.trustScore || 0}</span></td>
                            <td>${p.contactPhone}</td>
                            <td><span class="badge bg-info  text-dark">${p.providerType}</span></td>
                            <td>${ratingHtml} ${reviewHtml}</td>
                         </tr>`;
                tableBody.innerHTML += row;
            });
        }

        function extractPageMeta(p) {
            const number =
                (p.number ?? p.pageNumber ?? p.page?.number ?? 0);
            const totalPages =
                (p.totalPages ?? p.page?.totalPages ?? p.pageTotal ?? 0);
            const first = (p.first ?? (Number(number) === 0));
            const last = (p.last ?? (Number(number) >= Number(totalPages) - 1));

            return {
                number: Number(number),
                totalPages: Number(totalPages),
                first: Boolean(first),
                last: Boolean(last)
            };
        }

        function renderPagination(pageData) {
            const { number: current, totalPages: total, first, last } = extractPageMeta(pageData);
            const ul = document.getElementById('pagination');
            ul.innerHTML = '';
            if (!Number.isFinite(total) || total <= 0) return;

            const blockSize = 10;
            const blockStart = Math.floor(current / blockSize) * blockSize;
            const blockEnd = Math.min(blockStart + blockSize, total);

            const addBtn = (label, page, disabled = false, active = false) => {
                const li = document.createElement('li');
                li.className = `page-item${disabled ? ' disabled' : ''}${active ? ' active' : ''}`;
                const a = document.createElement('a');
                a.className = 'page-link';
                a.href = '#';
                a.textContent = label;
                a.onclick = (e) => { e.preventDefault(); if (!disabled && !active) fetchAndRenderProviders(page); };
                li.appendChild(a);
                ul.appendChild(li);
            };

            addBtn('◀◀', 0, first);
            addBtn('◀', Math.max(0, current - 1), first);

            if (blockStart > 0) addBtn('…', blockStart - 1);

            for (let i = blockStart; i < blockEnd; i++) {
                addBtn(String(i + 1), i, false, i === current);
            }

            if (blockEnd < total) addBtn('…', blockEnd);

            addBtn('▶', Math.min(total - 1, current + 1), last);
            addBtn('▶▶', total - 1, last);
        }

        window.onload = () => fetchAndRenderProviders();
    </script>
</main>
</html>
